import { CONFIG } from "./config.js";

window.MentalPanda = new (class MentalPanda {
  constructor() {
    this.config = CONFIG;
    this.pageCache = {};
  }
})();

function fixPathname(pathname) {
  if (pathname.endsWith("/") && pathname !== "/") return pathname.slice(0, -1);

  return pathname;
}

function getPageCache(name) {
  return window.MentalPanda.pageCache[name];
}

function setPageCache(name, data) {
  window.MentalPanda.pageCache[name] = data;
}

function loadPage(page) {
  document.getElementById("page-script")?.remove();

  if (getPageCache(page.name)) return document.getElementById("app").innerHTML = getPageCache(page.name);

  fetch(`${page.pagePath}/index.html`)
    .then(async (res) => {
      const html = await res.text();

      const title = page.title ?? `${page.name} - MentalPanda`;
      const style = page.hasCss
        ? `<link rel="stylesheet" href="${page.pagePath}/styles.css">`
        : "";

      if (page.hasJs) {
        const script = document.createElement("script");
        script.src = `${page.pagePath}/script.js`;
        script.id = "page-script";

        document.body.appendChild(script);
      }

      window.history.replaceState({}, "", page.paths?.[0] || "/");

      document.getElementById("app").innerHTML = `
                <head>
                    ${style}
                </head>

                ${html}
            `;

      document.body.scrollTop = document.documentElement.scrollTop = 0;

      document.title = title;
      
      setPageCache(page.name, html);
    })
    .catch((error) => console.error(error));
}

function loadPageByPath(path) {
  const pathname = fixPathname(path);

  const route = window.MentalPanda.config.pages.find((page) => {
    return page.paths && page.paths.includes(pathname);
  });
  if (!route) return;

  loadPage(route);
}

function createNavLink(entry) {
  const li = document.createElement("li");
  li.className = "nav-item";

  const a = document.createElement("a");
  a.className = "nav-link";
  a.textContent = entry.label;
  a.href = entry.to;
  a.addEventListener("click", function (e) {
    e.preventDefault();

    loadPageByPath(entry.to);
  });

  li.appendChild(a);

  return li;
}

document.addEventListener("DOMContentLoaded", async function () {
  const mainNavItems = document.getElementById("mainNavItems");

  window.MentalPanda.config.nav.forEach((entry) => {
    const navLink = createNavLink(entry);

    mainNavItems.appendChild(navLink);
  });

  loadPageByPath(window.location.pathname);
});